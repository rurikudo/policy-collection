# This policy verifies the installation of Integrity Shield on the managed clusters.
# 
# "enforce", it will install Integirty Shield operator

apiVersion: policy.open-cluster-management.io/v1
kind: Policy
metadata:
  name: policy-integrity-shield
  annotations:
    policy.open-cluster-management.io/standards: NIST SP 800-53
    policy.open-cluster-management.io/categories: CM Configuration Management
    policy.open-cluster-management.io/controls: CM-5 Access Restrictions for Change
    integrityshield.io/message: H4sIAAp3PGAAA+1ZX2/bNhB/96cglLchVFJsATa9ed6w9aGZUWd9WftAU2eZi0RqJOXFK/rdeyQlW3Yky0mdbBlKFEkjHu/v70534hm5WQpDSpULviYr0GIhwBC7BCKksSzPmRVKErUgr6WFTAu7JrOlgDwl+NjRFUyyDFLC88pY0CYenRH8F4FcKM0hOifCkr9FnjccAyehW5xK0MwqPRqxUrxDHigyqZWKcVPSmjkNwgqQNhbqYvVqdCtkmpCpJx0VYFnKLEtGhEhWQMODikZ3arxE3GdSKuuNM46cHCEOtZcp06lJyPXr2Q2ZTcn3l5f06tsjz3OGWiiNDk7I5A2ZKLkQWaWDh99sSI/lpqTVKve86BUZcw7GkLdgrBbc20UwAGSyZDKDkSmBOzs1nk+FFzn2VAmGBekK3EuFYfMc0J8LlhsYNVpQC0WJQIDaU5So+Z/A7U+wEFJ4Jv65Ww8OYHMwBHLHJ3VUG4p2dJt1MMrU7ZqScdicaNzQrA531LglZx7dex7wDOJ7pwjmkMLs0SJNQZL5OpzVwJFOZqRkGlVB+8mK5RX4wHRzilvKGXAJadcJ+VVky9ZGcP9+WJpFCVe4IZjkcLMu0T8F+h7RvmQr2KEkBwK5G5fre57sCngrnIeCthu8e1FrqgE1a4RM8bIgp7KXjrXlv4e1diQbFJiYKw3K/SouOgAWgvhbTf2LVlX5RSDcoC/rZBUO+FQ4ErrttQ+JZlmmM7CbJDNdNM7Z/69cMdX8a7I8ZbKwvFyyvpSZVXPDtSgd91OW7WdKGY59jYQ8Id7IDoK625zmTI7LUisMcELGlVUFRpWfxC6jKu2MQm8XlWxXD9NLfb31hcs8FLKwmHb6FixipuMFiwexPFhE62T27oB+8eoyfhV/97JKANdfK8BJKgD+38Qb9wbvhvgdLAKboW7WzEW76xF1wIBG3zxTFchVloHufl2KAnGckL8qtnae6AH5xT1dHE9ERrJNpz1dvIGnlVnz7BPJFh4FCLePn7o08kxCZnbr5Sf7dYBcmZWYQXdXlz90mxCgME4LIX9Hva59mKMQmMQpKjgwzlUlbdJjIMXf7meaIjZvw3YO9QMaEpdbnUfdGsgZR8abSjmDHDNB9bjc0aMGKfRtu7SLvukWRQjcDR++reZAezl4km0t76QzIpOgD0XIO0X0tX5OhhxoDze6HNA06DHEYMawSMHM0/bxosS4ICEyJiG+Ty90gA+tK9JR6mMBhHUdD2L8ARr4U9zgfqPfoMrX5gGLoGACW47ucGyl97T6wZaHaWaA6zBGJE6AxipGw7OOAxpCQ+L8hIRTrRYi7x89dt7j2nRNRm5ho2XRNW+rXlaBHTZhfHnIf44IX2p+oDuiUekrDZnEhvg02lRY++Sji2FyICtPwb8utr1SfOc0WQK//a/Eplk7n3B7SJCrKsQ/MGUW2csXpr5bLrJTjd3cnSsJcV+YKlln0NjaQyXzWc1kh3UJoqKmV4xbn9bj9xErS3Nowlgq44YbmkKZq7X7AP0+GkqVL5VlWrPv00kza8lpKLJPJwQHGSU5Vm7soR9qTs7mkDshR9w21E8djJ9BhO9znkiOVsrWPWi/hL0vckMtKE4iToFhMhLy9uc7nECN2d4+9duIL/JjBnVh6j6s/1P97mpGLjcEDpD6ydgk5I/I6gqiDyNK6aOv6txHDvf0R/wTc7Hj0m4edmjf5V3ZsHgLi9ZVX/O099ymVm/O45twRFpFciDZRu3Gjw5eMXa8Gx5Sj/edPFQJ7rvY29dxKTroqWbcrgVhp5qK1lUpdZ+kbIWIiG4cIGr4WD9ehovMdLJ3dLzCbthV9y3b3WzpywtKPvoUALkSWkmn9/kOeM9b+ExhFX34NPoMmgfZoNceAAA=
    integrityshield.io/signature: LS0tLS1CRUdJTiBQR1AgU0lHTkFUVVJFLS0tLS0KCmlRRktCQUFCQ0FBMEZpRUVRRmVCc3JTbUw2Ukh4YVJJK2s3U1hTeUFnTDhGQW1BOGR3b1dISE5wWjI1bGNrQmwKYm5SbGNuQnlhWE5sTG1OdmJRQUtDUkQ2VHRKZExJQ0F2OHFxQi80eERWcGc4V1QyYkVjNktwVmFScUE5MXhpbAp0eEFsNkxaR2Q3b2VTU3Zya3NIQTFEWGVsM2ZhMmI2ZVBhR2Z5clZRYUxPNjFMK0lvTlVwZlpnc1pWeVNpKzdQCkhBOTBEYWc0d1U4M0xFcEE0Sm9XQlFDdjdDV1NELzhRLzhmUU5PcXE3T2ovQlUvV1l5Sk9zQUE1Vlh3L0ZwSTMKUzFFNzJJZzJEeDdlTGxUa1I5SHQ2R0lwVnVGemp5T2ZDbnpyRW5MQkM0K2RSTmF1UlZPVUxObG9GNklmTEkxbAp5bG5mRWR1VWxvaE13S0M4NThlNVdGamxiYVNJVm5OZ2Z0UmJWa2UwanQxYW1YLy9tVmlDT09CS21ZQVZFSGVKCmtISHBHL2dhdmR6OGtpS2QvNU9rK1JUR0RKdmJBQ210U1Y0R1JrazNZYzdkYzZlUEdPcHRZaFRFKzl4Two9R0dyaQotLS0tLUVORCBQR1AgU0lHTkFUVVJFLS0tLS0K
spec:
  remediationAction: inform
  disabled: false
  policy-templates:
    - objectDefinition:
        apiVersion: policy.open-cluster-management.io/v1
        kind: ConfigurationPolicy
        metadata:
          name: policy-integrity-shield-namespace
        spec:
          remediationAction: enforce # the policy-template spec.remediationAction is overridden by the preceding parameter value for spec.remediationAction.
          severity: High
          object-templates:
            - complianceType: mustnothave
              objectDefinition:
                kind: Namespace
                apiVersion: v1
                metadata:
                  name: integrity-shield-operator-system
    - objectDefinition:
        apiVersion: policy.open-cluster-management.io/v1
        kind: ConfigurationPolicy
        metadata:
          name: policy-integrity-shield-og
        spec:
          remediationAction: enforce # the policy-template spec.remediationAction is overridden by the preceding parameter value for spec.remediationAction.
          severity: high
          object-templates:
            - complianceType: mustnothave
              objectDefinition:
                apiVersion: operators.coreos.com/v1
                kind: OperatorGroup
                metadata:
                  name: integrity-operator-group
                  namespace: integrity-shield-operator-system
                spec:
                  targetNamespaces:
                    - integrity-shield-operator-system
    - objectDefinition:
        apiVersion: policy.open-cluster-management.io/v1
        kind: ConfigurationPolicy
        metadata:
          name: policy-integrity-shield-sub
        spec:
          remediationAction: enforce # the policy-template spec.remediationAction is overridden by the preceding parameter value for spec.remediationAction.
          severity: high
          object-templates:
            - complianceType: mustnothave
              objectDefinition:
                apiVersion: operators.coreos.com/v1alpha1
                kind: Subscription
                metadata:
                  name: integrity-shield-operator
                  namespace: integrity-shield-operator-system
                spec:
                  channel: alpha
                  installPlanApproval: Automatic
                  name: integrity-shield-operator
                  source: community-operators
                  sourceNamespace: openshift-marketplace
                  startingCSV: integrity-shield-operator.v0.1.4
    - objectDefinition:
        apiVersion: policy.open-cluster-management.io/v1
        kind: ConfigurationPolicy
        metadata:
          name: policy-integrity-shield-cr
        spec:
          remediationAction: enforce # the policy-template spec.remediationAction is overridden by the preceding parameter value for spec.remediationAction.
          severity: high
          object-templates:
            - complianceType: mustnothave
              objectDefinition:
                apiVersion: apis.integrityshield.io/v1alpha1
                kind: IntegrityShield
                metadata:
                  name: integrity-shield-server
                  namespace: integrity-shield-operator-system
                spec:
                  logger:
                    image: quay.io/open-cluster-management/integrity-shield-logging:0.1.4
                  server:
                    image: quay.io/open-cluster-management/integrity-shield-server:0.1.4
                  affinity: {}
                  shieldConfig:
                    verifyType: pgp # x509
                    iShieldAdminUserName: "system:serviceaccount:open-cluster-management-agent-addon:klusterlet-addon-policyctrl"
                    inScopeNamespaceSelector:
                      include:
                        - "*"
                      exclude:
                        - "kube-*"
                        - "openshift-*"
                  signerConfig:
                    policies:
                      - namespaces:
                          - "*"
                        signers:
                          - "SampleSigner"
                      - scope: "Cluster"
                        signers:
                          - "SampleSigner"
                    signers:
                      - name: "SampleSigner"
                        keyConfig: sample-signer-keyconfig
                        subjects:
                          - email: "*"
                  keyConfig:
                    - name: sample-signer-keyconfig
                      secretName: keyring-secret
                  resourceSigningProfiles:
                    - name: policy-rsp
                      protectRules:
                        - match:
                            - apiGroup: policy.open-cluster-management.io
                      ignoreRules:
                        - match:
                            - username: "system:serviceaccount:open-cluster-management-agent:*"
                            - username: "system:serviceaccount:open-cluster-management-agent-addon:*"
                      forceCheckRules:
                        - match:
                            - apiGroup: policy.open-cluster-management.io
                              kind: Policy
                      kustomizePatterns:
                        - match:
                            - apiGroup: policy.open-cluster-management.io
                              kind: Policy
                          namePrefix: "*."
                      unprotectAttrs:
                        - match:
                            - apiGroup: policy.open-cluster-management.io
                          attrs:
                            - "metadata.annotations.\"apps.open-cluster-management.io/hosting-deployable\""
                            - "metadata.annotations.\"apps.open-cluster-management.io/hosting-subscription\""
                            - "metadata.annotations.\"apps.open-cluster-management.io/sync-source\""
                            - "metadata.annotations.\"apps.open-cluster-management.io/reconcile-option\""
                            - "metadata.labels.\"policy.open-cluster-management.io/cluster-name\""
                            - "metadata.labels.\"policy.open-cluster-management.io/cluster-namespace\""
                            - "metadata.labels.\"policy.open-cluster-management.io/root-policy\""
                      targetNamespaceSelector:
                        labelSelector:
                          matchExpressions:
                            - key: policy.open-cluster-management.io/isClusterNamespace
                              operator: In
                              values: ["true"]
---
apiVersion: policy.open-cluster-management.io/v1
kind: PlacementBinding
metadata:
  name: binding-policy-integrity-shield
  annotations:
    integrityshield.io/message: H4sIAAp3PGAAA+1ZX2/bNhB/96cglLchVFJsATa9ed6w9aGZUWd9WftAU2eZi0RqJOXFK/rdeyQlW3Yky0mdbBlKFEkjHu/v70534hm5WQpDSpULviYr0GIhwBC7BCKksSzPmRVKErUgr6WFTAu7JrOlgDwl+NjRFUyyDFLC88pY0CYenRH8F4FcKM0hOifCkr9FnjccAyehW5xK0MwqPRqxUrxDHigyqZWKcVPSmjkNwgqQNhbqYvVqdCtkmpCpJx0VYFnKLEtGhEhWQMODikZ3arxE3GdSKuuNM46cHCEOtZcp06lJyPXr2Q2ZTcn3l5f06tsjz3OGWiiNDk7I5A2ZKLkQWaWDh99sSI/lpqTVKve86BUZcw7GkLdgrBbc20UwAGSyZDKDkSmBOzs1nk+FFzn2VAmGBekK3EuFYfMc0J8LlhsYNVpQC0WJQIDaU5So+Z/A7U+wEFJ4Jv65Ww8OYHMwBHLHJ3VUG4p2dJt1MMrU7ZqScdicaNzQrA531LglZx7dex7wDOJ7pwjmkMLs0SJNQZL5OpzVwJFOZqRkGlVB+8mK5RX4wHRzilvKGXAJadcJ+VVky9ZGcP9+WJpFCVe4IZjkcLMu0T8F+h7RvmQr2KEkBwK5G5fre57sCngrnIeCthu8e1FrqgE1a4RM8bIgp7KXjrXlv4e1diQbFJiYKw3K/SouOgAWgvhbTf2LVlX5RSDcoC/rZBUO+FQ4ErrttQ+JZlmmM7CbJDNdNM7Z/69cMdX8a7I8ZbKwvFyyvpSZVXPDtSgd91OW7WdKGY59jYQ8Id7IDoK625zmTI7LUisMcELGlVUFRpWfxC6jKu2MQm8XlWxXD9NLfb31hcs8FLKwmHb6FixipuMFiwexPFhE62T27oB+8eoyfhV/97JKANdfK8BJKgD+38Qb9wbvhvgdLAKboW7WzEW76xF1wIBG3zxTFchVloHufl2KAnGckL8qtnae6AH5xT1dHE9ERrJNpz1dvIGnlVnz7BPJFh4FCLePn7o08kxCZnbr5Sf7dYBcmZWYQXdXlz90mxCgME4LIX9Hva59mKMQmMQpKjgwzlUlbdJjIMXf7meaIjZvw3YO9QMaEpdbnUfdGsgZR8abSjmDHDNB9bjc0aMGKfRtu7SLvukWRQjcDR++reZAezl4km0t76QzIpOgD0XIO0X0tX5OhhxoDze6HNA06DHEYMawSMHM0/bxosS4ICEyJiG+Ty90gA+tK9JR6mMBhHUdD2L8ARr4U9zgfqPfoMrX5gGLoGACW47ucGyl97T6wZaHaWaA6zBGJE6AxipGw7OOAxpCQ+L8hIRTrRYi7x89dt7j2nRNRm5ho2XRNW+rXlaBHTZhfHnIf44IX2p+oDuiUekrDZnEhvg02lRY++Sji2FyICtPwb8utr1SfOc0WQK//a/Eplk7n3B7SJCrKsQ/MGUW2csXpr5bLrJTjd3cnSsJcV+YKlln0NjaQyXzWc1kh3UJoqKmV4xbn9bj9xErS3Nowlgq44YbmkKZq7X7AP0+GkqVL5VlWrPv00kza8lpKLJPJwQHGSU5Vm7soR9qTs7mkDshR9w21E8djJ9BhO9znkiOVsrWPWi/hL0vckMtKE4iToFhMhLy9uc7nECN2d4+9duIL/JjBnVh6j6s/1P97mpGLjcEDpD6ydgk5I/I6gqiDyNK6aOv6txHDvf0R/wTc7Hj0m4edmjf5V3ZsHgLi9ZVX/O099ymVm/O45twRFpFciDZRu3Gjw5eMXa8Gx5Sj/edPFQJ7rvY29dxKTroqWbcrgVhp5qK1lUpdZ+kbIWIiG4cIGr4WD9ehovMdLJ3dLzCbthV9y3b3WzpywtKPvoUALkSWkmn9/kOeM9b+ExhFX34NPoMmgfZoNceAAA=
    integrityshield.io/signature: LS0tLS1CRUdJTiBQR1AgU0lHTkFUVVJFLS0tLS0KCmlRRktCQUFCQ0FBMEZpRUVRRmVCc3JTbUw2Ukh4YVJJK2s3U1hTeUFnTDhGQW1BOGR3b1dISE5wWjI1bGNrQmwKYm5SbGNuQnlhWE5sTG1OdmJRQUtDUkQ2VHRKZExJQ0F2OHFxQi80eERWcGc4V1QyYkVjNktwVmFScUE5MXhpbAp0eEFsNkxaR2Q3b2VTU3Zya3NIQTFEWGVsM2ZhMmI2ZVBhR2Z5clZRYUxPNjFMK0lvTlVwZlpnc1pWeVNpKzdQCkhBOTBEYWc0d1U4M0xFcEE0Sm9XQlFDdjdDV1NELzhRLzhmUU5PcXE3T2ovQlUvV1l5Sk9zQUE1Vlh3L0ZwSTMKUzFFNzJJZzJEeDdlTGxUa1I5SHQ2R0lwVnVGemp5T2ZDbnpyRW5MQkM0K2RSTmF1UlZPVUxObG9GNklmTEkxbAp5bG5mRWR1VWxvaE13S0M4NThlNVdGamxiYVNJVm5OZ2Z0UmJWa2UwanQxYW1YLy9tVmlDT09CS21ZQVZFSGVKCmtISHBHL2dhdmR6OGtpS2QvNU9rK1JUR0RKdmJBQ210U1Y0R1JrazNZYzdkYzZlUEdPcHRZaFRFKzl4Two9R0dyaQotLS0tLUVORCBQR1AgU0lHTkFUVVJFLS0tLS0K
placementRef:
  name: placement-policy-integrity-shield
  kind: PlacementRule
  apiGroup: apps.open-cluster-management.io
subjects:
  - name: policy-integrity-shield
    kind: Policy
    apiGroup: policy.open-cluster-management.io
---
apiVersion: apps.open-cluster-management.io/v1
kind: PlacementRule
metadata:
  name: placement-policy-integrity-shield
  annotations:
    integrityshield.io/message: H4sIAAp3PGAAA+1ZX2/bNhB/96cglLchVFJsATa9ed6w9aGZUWd9WftAU2eZi0RqJOXFK/rdeyQlW3Yky0mdbBlKFEkjHu/v70534hm5WQpDSpULviYr0GIhwBC7BCKksSzPmRVKErUgr6WFTAu7JrOlgDwl+NjRFUyyDFLC88pY0CYenRH8F4FcKM0hOifCkr9FnjccAyehW5xK0MwqPRqxUrxDHigyqZWKcVPSmjkNwgqQNhbqYvVqdCtkmpCpJx0VYFnKLEtGhEhWQMODikZ3arxE3GdSKuuNM46cHCEOtZcp06lJyPXr2Q2ZTcn3l5f06tsjz3OGWiiNDk7I5A2ZKLkQWaWDh99sSI/lpqTVKve86BUZcw7GkLdgrBbc20UwAGSyZDKDkSmBOzs1nk+FFzn2VAmGBekK3EuFYfMc0J8LlhsYNVpQC0WJQIDaU5So+Z/A7U+wEFJ4Jv65Ww8OYHMwBHLHJ3VUG4p2dJt1MMrU7ZqScdicaNzQrA531LglZx7dex7wDOJ7pwjmkMLs0SJNQZL5OpzVwJFOZqRkGlVB+8mK5RX4wHRzilvKGXAJadcJ+VVky9ZGcP9+WJpFCVe4IZjkcLMu0T8F+h7RvmQr2KEkBwK5G5fre57sCngrnIeCthu8e1FrqgE1a4RM8bIgp7KXjrXlv4e1diQbFJiYKw3K/SouOgAWgvhbTf2LVlX5RSDcoC/rZBUO+FQ4ErrttQ+JZlmmM7CbJDNdNM7Z/69cMdX8a7I8ZbKwvFyyvpSZVXPDtSgd91OW7WdKGY59jYQ8Id7IDoK625zmTI7LUisMcELGlVUFRpWfxC6jKu2MQm8XlWxXD9NLfb31hcs8FLKwmHb6FixipuMFiwexPFhE62T27oB+8eoyfhV/97JKANdfK8BJKgD+38Qb9wbvhvgdLAKboW7WzEW76xF1wIBG3zxTFchVloHufl2KAnGckL8qtnae6AH5xT1dHE9ERrJNpz1dvIGnlVnz7BPJFh4FCLePn7o08kxCZnbr5Sf7dYBcmZWYQXdXlz90mxCgME4LIX9Hva59mKMQmMQpKjgwzlUlbdJjIMXf7meaIjZvw3YO9QMaEpdbnUfdGsgZR8abSjmDHDNB9bjc0aMGKfRtu7SLvukWRQjcDR++reZAezl4km0t76QzIpOgD0XIO0X0tX5OhhxoDze6HNA06DHEYMawSMHM0/bxosS4ICEyJiG+Ty90gA+tK9JR6mMBhHUdD2L8ARr4U9zgfqPfoMrX5gGLoGACW47ucGyl97T6wZaHaWaA6zBGJE6AxipGw7OOAxpCQ+L8hIRTrRYi7x89dt7j2nRNRm5ho2XRNW+rXlaBHTZhfHnIf44IX2p+oDuiUekrDZnEhvg02lRY++Sji2FyICtPwb8utr1SfOc0WQK//a/Eplk7n3B7SJCrKsQ/MGUW2csXpr5bLrJTjd3cnSsJcV+YKlln0NjaQyXzWc1kh3UJoqKmV4xbn9bj9xErS3Nowlgq44YbmkKZq7X7AP0+GkqVL5VlWrPv00kza8lpKLJPJwQHGSU5Vm7soR9qTs7mkDshR9w21E8djJ9BhO9znkiOVsrWPWi/hL0vckMtKE4iToFhMhLy9uc7nECN2d4+9duIL/JjBnVh6j6s/1P97mpGLjcEDpD6ydgk5I/I6gqiDyNK6aOv6txHDvf0R/wTc7Hj0m4edmjf5V3ZsHgLi9ZVX/O099ymVm/O45twRFpFciDZRu3Gjw5eMXa8Gx5Sj/edPFQJ7rvY29dxKTroqWbcrgVhp5qK1lUpdZ+kbIWIiG4cIGr4WD9ehovMdLJ3dLzCbthV9y3b3WzpywtKPvoUALkSWkmn9/kOeM9b+ExhFX34NPoMmgfZoNceAAA=
    integrityshield.io/signature: LS0tLS1CRUdJTiBQR1AgU0lHTkFUVVJFLS0tLS0KCmlRRktCQUFCQ0FBMEZpRUVRRmVCc3JTbUw2Ukh4YVJJK2s3U1hTeUFnTDhGQW1BOGR3b1dISE5wWjI1bGNrQmwKYm5SbGNuQnlhWE5sTG1OdmJRQUtDUkQ2VHRKZExJQ0F2OHFxQi80eERWcGc4V1QyYkVjNktwVmFScUE5MXhpbAp0eEFsNkxaR2Q3b2VTU3Zya3NIQTFEWGVsM2ZhMmI2ZVBhR2Z5clZRYUxPNjFMK0lvTlVwZlpnc1pWeVNpKzdQCkhBOTBEYWc0d1U4M0xFcEE0Sm9XQlFDdjdDV1NELzhRLzhmUU5PcXE3T2ovQlUvV1l5Sk9zQUE1Vlh3L0ZwSTMKUzFFNzJJZzJEeDdlTGxUa1I5SHQ2R0lwVnVGemp5T2ZDbnpyRW5MQkM0K2RSTmF1UlZPVUxObG9GNklmTEkxbAp5bG5mRWR1VWxvaE13S0M4NThlNVdGamxiYVNJVm5OZ2Z0UmJWa2UwanQxYW1YLy9tVmlDT09CS21ZQVZFSGVKCmtISHBHL2dhdmR6OGtpS2QvNU9rK1JUR0RKdmJBQ210U1Y0R1JrazNZYzdkYzZlUEdPcHRZaFRFKzl4Two9R0dyaQotLS0tLUVORCBQR1AgU0lHTkFUVVJFLS0tLS0K
spec:
  clusterConditions:
    - status: "True"
      type: ManagedClusterConditionAvailable
  clusterSelector:
    matchExpressions:
      - {key: environment, operator: In, values: ["dev"]}
